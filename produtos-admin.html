<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Produtos ‚Äî TechSolv Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="main.css"/>
  <style>
    .modal-overlay { display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;align-items:center;justify-content:center; }
    .modal-overlay.open { display:flex; }
    .modal-box { background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:2rem;width:100%;max-width:500px;max-height:90vh;overflow-y:auto; }
    .modal-header { display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem; }
    .modal-header h3 { font-family:var(--font-head);font-size:1.15rem; }
    .modal-close { background:none;border:none;color:var(--text-muted);font-size:1.3rem;cursor:pointer; }
    .modal-close:hover { color:var(--text); }
    .action-btn { background:none;border:1px solid var(--border);color:var(--text-muted);border-radius:6px;padding:.3rem .7rem;font-size:.78rem;cursor:pointer;transition:.2s; }
    .action-btn:hover { border-color:var(--accent);color:var(--accent); }
    .action-btn.del:hover { border-color:#e05050;color:#e05050; }
  </style>
</head>
<body>

<div class="admin-layout">
  <aside class="admin-sidebar">
    <a href="dashboard.html" class="logo" style="display:block;">TECH<span>SOLV</span></a>
    <nav class="sidebar-nav">
      <a href="dashboard.html"><span>üìä</span> Dashboard</a>
      <a href="mensagens.html"><span>‚úâÔ∏è</span> Mensagens</a>
      <a href="orcamentos.html"><span>üìã</span> Or√ßamentos</a>
      <div class="sidebar-divider"></div>
      <a href="produtos-admin.html" class="active"><span>üì¶</span> Produtos</a>
      <a href="conteudo.html"><span>‚úèÔ∏è</span> Conte√∫do</a>
      <div class="sidebar-divider"></div>
      <a href="../index.html" target="_blank"><span>üåê</span> Ver Site</a>
      <a href="#" onclick="logout()"><span>üîí</span> Sair</a>
    </nav>
  </aside>

  <main class="admin-main">
    <div class="admin-header">
      <div><h1>Gest√£o de Produtos</h1><p>Adicione, edite ou remova produtos do cat√°logo.</p></div>
      <button class="btn-primary" onclick="openModal()">+ Novo Produto</button>
    </div>

    <div class="table-wrap">
      <table class="data-table">
        <thead><tr><th>√çcone</th><th>Nome</th><th>Categoria</th><th>Pre√ßo</th><th>Unidade</th><th>A√ß√µes</th></tr></thead>
        <tbody id="tbodyProd"></tbody>
      </table>
    </div>
  </main>
</div>

<!-- Modal Produto -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal-box">
    <div class="modal-header">
      <h3 id="modalTitle">Novo Produto</h3>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <form id="formProd" novalidate>
      <input type="hidden" id="prodId"/>
      <div class="form-group">
        <label>√çcone (emoji)</label>
        <input type="text" id="prodIcone" placeholder="‚öôÔ∏è" required/>
      </div>
      <div class="form-group">
        <label>Nome do Produto *</label>
        <input type="text" id="prodNome" required placeholder="Nome do produto"/>
      </div>
      <div class="form-group">
        <label>Descri√ß√£o *</label>
        <textarea id="prodDesc" required placeholder="Descri√ß√£o t√©cnica..." style="min-height:80px;"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Categoria *</label>
          <select id="prodCat" required>
            <option>Automa√ß√£o</option><option>Motores</option><option>Sensores</option>
            <option>Prote√ß√£o</option><option>Cabos</option><option>Outros</option>
          </select>
        </div>
        <div class="form-group">
          <label>Unidade</label>
          <select id="prodUnid">
            <option>unid.</option><option>rolo</option><option>metro</option><option>par</option><option>kit</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Pre√ßo (R$) *</label>
        <input type="number" id="prodPreco" step="0.01" min="0" required placeholder="0,00"/>
      </div>
      <button type="submit" class="btn-primary" style="width:100%;padding:.9rem;margin-top:.5rem;">Salvar Produto</button>
    </form>
  </div>
</div>

<script src="main.js"></script>
<script src="produtos.js"></script>
<script>
  requireAuth();

  // Carrega produtos do storage ou usa padr√£o
  function getProds() {
    const stored = DB.get('produtos_custom');
    return stored.length > 0 ? stored : [...PRODUTOS_DB];
  }
  function saveProds(arr) { DB.set('produtos_custom', arr); }

  function renderTable() {
    const prods = getProds();
    document.getElementById('tbodyProd').innerHTML = prods.map(p => `
      <tr>
        <td style="font-size:1.4rem;">${p.icone}</td>
        <td><strong>${p.nome}</strong><br><small style="color:var(--text-muted);font-size:.78rem;">${p.descricao.substring(0,50)}...</small></td>
        <td><span class="badge badge-yellow">${p.categoria}</span></td>
        <td style="color:var(--accent);font-weight:700;">R$ ${p.preco.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>
        <td>${p.unidade}</td>
        <td style="display:flex;gap:.5rem;">
          <button class="action-btn" onclick="editProd(${p.id})">‚úèÔ∏è Editar</button>
          <button class="action-btn del" onclick="delProd(${p.id})">üóëÔ∏è Excluir</button>
        </td>
      </tr>
    `).join('');
  }

  function openModal(id) {
    document.getElementById('modalOverlay').classList.add('open');
    document.getElementById('modalTitle').textContent = id ? 'Editar Produto' : 'Novo Produto';
    if (!id) {
      document.getElementById('formProd').reset();
      document.getElementById('prodId').value = '';
    }
  }
  function closeModal() { document.getElementById('modalOverlay').classList.remove('open'); }

  function editProd(id) {
    const p = getProds().find(x => x.id === id);
    if (!p) return;
    document.getElementById('prodId').value = p.id;
    document.getElementById('prodIcone').value = p.icone;
    document.getElementById('prodNome').value = p.nome;
    document.getElementById('prodDesc').value = p.descricao;
    document.getElementById('prodCat').value = p.categoria;
    document.getElementById('prodUnid').value = p.unidade;
    document.getElementById('prodPreco').value = p.preco;
    openModal(id);
  }

  function delProd(id) {
    if (!confirm('Remover este produto?')) return;
    const prods = getProds().filter(p => p.id !== id);
    saveProds(prods);
    renderTable();
  }

  document.getElementById('formProd').addEventListener('submit', function(e) {
    e.preventDefault();
    const prods = getProds();
    const editId = parseInt(this.elements['prodId'].value);
    const prod = {
      id: editId || Date.now(),
      icone: document.getElementById('prodIcone').value || 'üì¶',
      nome: document.getElementById('prodNome').value,
      descricao: document.getElementById('prodDesc').value,
      categoria: document.getElementById('prodCat').value,
      unidade: document.getElementById('prodUnid').value,
      preco: parseFloat(document.getElementById('prodPreco').value) || 0,
    };

    if (editId) {
      const idx = prods.findIndex(p => p.id === editId);
      if (idx >= 0) prods[idx] = prod;
    } else {
      prods.push(prod);
    }
    saveProds(prods);
    closeModal();
    renderTable();
  });

  document.getElementById('modalOverlay').addEventListener('click', e => {
    if (e.target === document.getElementById('modalOverlay')) closeModal();
  });

  renderTable();
</script>
</body>
</html>
